# Общие понятия

client_id - идентификатор проекта ГигаЧат АПИ, находится в проекте в личном кабинете (на 20/08/2024) в правом верхнем углу под строкой «используйте ключи для подключения сервиса». Для поиска внут¸ри журналов, для поиска сообщений, ошибок обычно запрашивается именно он. Внутри одного корпоративного пространства может быть до 5 разных проектов ГигаЧат. Чтобы в корпоративном пространстве можно было добавлять больше 5 проектов - необходимо запрашивать доступ дополнительно. У физлиц проект может быть (на данный момент) только один.

workspace_id - идентификатор пространства внутри Студии. Может помочь при решении вопросов для юрлиц по организации доступа, оформлению корпоративного пространства. В остальных случаях смотрите client_id

Цензор - он же этический, он же тематический фильтр. Подсистема которая блокирует отправку сообщений если там содержится потенциально опасная информация. О том какие темы могут его триггерить можно почитать по ссылке https://developers.sber.ru/docs/ru/gigachat/limitations#tematicheskie-ogranicheniya-zaprosov

О том что цензор сработал можно узнать по ошибке blacklist в ответе модели.

Цензор может быть отключен только для юридических лиц (корпоративных пространств) с согласования владельца продукта, необходимо прислать 2-3 примера сработки цензора, полное описание сценария применения (кто пользователи, какой алгоритм применения ГигаЧат). Другим способом отключить его нельзя.

Потоки - количество единовременно обрабатываемых запросов. Для физлиц - 1 поток, для юрлиц - 10 потоков. Количество потоков привязано к конкретному client_id проекта GigaChat API (для Enablers) и Common Name сертификата (для Банка). Увеличение количества потоков для Enablers возможно только для корпоративных пространств (юрлиц) через согласованием с владельцем продукта, для физлиц такой процедуры не предусмотрено даже если они покупают платные пакеты. Для расширения количества потоков необходимо предоставить Владельцу Продукта информацию о сценарии, DAU/MAU системы для которой запрашивается доступ и расчет требуемого количества потоков (почему хотят именно N потоков)

Инстансы - экземпляры ГигаЧат, внутри Банка их пять (ИФТ в Дельта, ПСИ и ПРОМ в Сигма, ПСИ и ПРОМ в Альфа), также есть публично доступный инстанс в сетевом регионе Enablers. Доступ к Enablers пользователь (в том числе и внутрибанковский) оформляет самостоятельно через Студию. Доступ к банковским инстансам оформляется через заявки на отдел сопровождение. (см API)  

GigaChain / ГигаЧейн - библиотека для языка Python нашей разработки. Адрес для внешних потребителей https://github.com/ai-forever/gigachain/ сама по себе не предоставляет доступ к ГигаЧат, при работе с ней также требуются авторизационные данные. Содержит огромное количество примеров кода в разной степени применимости в разных процессах. Любые вопросы по ней отправляются Поддержкой на команду GigaChain  

ENABLERS - публично доступный инстанс ГигаЧат


## 1.2. Детальней про ошибки при работе с API

### 400, scope from db not fully includes consumed scope

Что происходит:

Пользователь не читал документацию и указал неверное значение параметра scope.

Что делать?

Указать корректный параметр scope согласно документации https://developers.sber.ru/docs/ru/gigachat/api/reference/rest/post-token#zapros

Версия API. Возможные значения:

GIGACHAT_API_PERS — доступ для физических лиц.

GIGACHAT_API_B2B — доступ для ИП и юридических лиц по предоплате.

GIGACHAT_API_CORP — доступ для ИП и юридических лиц по постоплате.

Если пользователь работает через библиотеку GigaChain и получает эту ошибку, то скорее всего параметр scope там вообще не указан и нужно добавить его в программный код в раздел параметров модели.



### 401, credentials doesn't match db data

Что происходит:

Неверное значение параметра «авторизационные данные»

Что делать:

Рекомендовать вернуться в личный кабинет и сгенерировать заново авторизационные данные «получить новый client_secret», либо убедиться что сформированный токен не «протух» (он живет 30 минут) 

Вполне возможна ситуация, когда человек заблуждается относительно природы доступа к АПИ, он считает что оформил корпоративный доступ, а по факту он зашел со SberID как физ.лицо, поэтому рекомендуем ему попробовать сначала одно, затем другое значение.



### 402, Payment Required​, Лимит по тарифу исчерпан

У пользователя кончились токены модели, к которой он пытается обращаться. Скорее всего он не указал в программном коде (или готовом сервисе) другую модель к которой надо обращаться. Посоветуйте прислать снимок экрана из личного кабинета так чтобы было видно сколько токенов в каком пакете у него осталось. Если он настаивает что все делает корректно - запрашивайте авторизационные данные и выполняйте вызов разных моделей самостоятельно. Следующим шагом заходите в статистику и смотрите сколько там фактически было истрачено. В редких случаях проблема может потребовать обращения к службе сопровождения.


429, Too many requests. Слишком много запросов.

Пользователь пытается выполнить большее количество одновременных запросов, чем разрешено его идентификатору. По умолчанию для физлиц - 1 одновременный поток, для юрлиц - 10 потоков. Для внутриБанковских потребителей - устанавливается по согласованию с Владельцем Продукта.



«ssl.SSLCertVerificationError: [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: self signed certificate in certificate chain»

Это ошибка присоединения к API возникает из-за сертификатов МинЦифры РФ, которые система пользователя приняла за самописные сертификаты.

Что делать? Рекомендовать к прочтению https://developers.sber.ru/docs/ru/gigachat/certificates  и устанавливать в коде приложения (или в настройках виртуального окружения). ВАЖНО! Пользователи часто ставят сертификаты только на уровне ОС (операционной системы), этого недостаточно, так как у средств разработки чаще всего свои venv (виртуальные окружения) в которых свои доверенные сертификаты. ВАЖНО! Конечно, пользователь может просто отключить проверку сертификатов на своей стороне (verify_ssl_certs=False например), но это НЕ РЕКОМЕНДУЕМОЕ ПОВЕДЕНИЕ!. 

Для пользователей GigaChain можно посоветовать утилиту gigachain-cli которая решает эти проблемы


## 1.3. Любые вопросы на тему «у меня не работает вызов к АПИ/API» 
Это могут быть ошибки например 401, 402, 403, 404. В 99.9% случаев это либо неверно сформированная строка вызова либо некорректно указанная модель либо протухший токен авторизации. Проще говоря - пользователь не читал или плохо читал документацию по обращению к API по ссылке https://developers.sber.ru/docs/ru/gigachat/api/reference/rest/gigachat-api

Что делать?

Запросить полный вид ошибки от сервиса и полный вид запроса включая данные авторизации. Нет ничего страшного в том что пользователь присылает нам авторизационные данные - это сильно проще чем вытаскивать логи.  Пользователь может заново перегенерировать авторизационные данные в Личном Кабинете студии после закрытия заявки.


После получения строк вызова сравнить их с актуальными вызовами из документа который будет передаваться отдельно. Документ держать актуальным при изменении методов.

Используйте авторизационные данные пользователя для того чтобы выполнить запросы авторизации и обращения к модели. Если CURL сложно - используйте Postman.

https://developers.sber.ru/docs/ru/gigachat/api/postman-request-collection  


## Очень частая ошибка при вызове Curl в Windows [(58) schannel: Failed to import cert file cert.pem, last error is 0x80092002

Что происходит:

При попытке отправки запроса в API с помощью curl на Windows возникает ошибка curl: (58) schannel: Failed to import cert file cert.pem, last error is

0x80092002. Ошибка происходит, потому что версия используемая версия curl не поддерживает формат хранения сертификата pem(стандарт OpenPGP).

Что делать:

Необходимо переконвертировать сертификат в по стандарту pkc#12:

openssl pkcs12 -export -out cert.p12 -in cert.pem -inkey private.key.

Далее используем сертификат в новом формате в качестве значения параметра –cert, например

curl https://gigachat-ift.sberdevices.delta.sbrf.ru/v1/models    --cert cert.p12   --key private.key

Самый простой способ - использовать/заказать в Друге виртуальную Linux машину


### 1.5. Любые вопросы про библиотеки GigaChain или библиотеку GigaChat
Сначала советуем пользователям удалить все библиотеки LangChain и переустановить/обновить GigaChain следующими командами

pip uninstall langchain langchain-core langchain-community langchain-eperimental (любые другие библиотеки langchain которые он еще мог поставить)

pip install -U gigachain-community

Если не помогло, то все последующие вопросы отправлять команде поддержки GigaChain 

Перед отправкой на команду ГигаЧейна всех пользователей:

- просить выполнить следующие команды и присылать результат работы:

pip install -U gigachain-cli

gigachain info

- В ответ утилита будет выдавать небольшой лог, который надо приложить к обращениям.


### Вопросы про Кандинский/генерацию изображений
«Картинка не того размера, не того формата»

Через ГигаЧат API в данный момент рисуется только 640 на 480. Любые другие соотношения сторон, разрешение - только при работе напрямую с Fusionbrain API (Кандинским)


«Сколько хранится картинка»

На данный момент все картинки хранятся без срока давности.


«Картинка которую я сгенерировал - может быть доступна кому-то еще?»

Нет.

### Проблема кодировки отправляемого сообщения через curl на Windows
Что происходит:

При попытке отправки запроса в API с помощью curl на Windows с использование кирилицы не правильно воспринмается вопрос/ответ с крокозябрами или совершенно не соответвуюе вопросу.

Пример:  curl --cert cert.p12 --key private.key --data "{\"model\":\"GigaChat:latest\",\"messages\": [{\"role\": \"user\", \"content\": \"repeAT THIS:  Попугая хороший\"}],\"n\":1,\"top_p\":0.47,\"stream\":false}" -v https://goprodigy-ci01808661-gigachat.apps.ift-terra000017-eds.ocp.delta.sbrf.ru/v1/chat/completions

Content ответа: "Повторите это: ������� �������"

Смена charset в командой строке не решвет проблему. Проблема связана с особенностью данной версии curl.

Что делать:

Подавать json из файла.

Пример: curl  --cert client.p12 --key private.key --data @data.txt -v https://goprodigy-ci01808661-gigachat.apps.ift-terra000017-eds.ocp.delta.sbrf.ru/v1/chat/completions

### Что делать если внешнему пользователю ничего не помогло
Даже после всех инструкций у пользователя не получается выполнить запрос самостоятельно. Или пользователь присылает какой-то свой код на любом языке программирования

Рекомендовать

использовать готовые примеры с сайта https://developers.sber.ru/docs/ru/gigachat/api/authorization

использовать коллекцию PostMan https://developers.sber.ru/docs/ru/gigachat/api/postman-request-collection при необходимости смотреть видео по использованию коллекции PostMan (там же)

использовать готовые примеры из библиотеки GigaChain https://github.com/ai-forever/gigachain/

Только если пользователь все попробовал – пусть присылает данные, под которыми работает (client_id, а также запрос ЦЕЛИКОМ и ответ ЦЕЛИКОМ на почту gigachat@sberbank.ru

Мы не обучаем пользователей программированию, наша ответственность – чтобы он выполнил успешно один запрос и получил ответ, все что дальше и как он будет использовать реализацию этого вызова – его зона ответственности.

### Частые вопросы внешних пользователей 
«Пропали токены, нет пакетов которые я вчера купил, исчез мой проект GigaChat API» и схожие обращения

Запросить снимок экрана, так чтобы было видно client_id, Workspace_id, остаток по пакетам. При необходимости список покупок. Уточнить не поменял ли пользователь параметры входа (например раньше ходил через СберИД а сейчас через логин/пароль). После чего посмотреть потребление по указанным данным client_id, возможно пользователь перепутал разные учетные записи. Если все совпадает то писать в канал ММ 



### «Юридические вопросы, коммерческое использование» и тд

Предлагаем ознакомиться с юридическими документами https://developers.sber.ru/docs/ru/policies/gigachat-agreement/individuals (для физиков), https://developers.sber.ru/docs/ru/policies/gigachat-agreement/permissible-use-ai и https://developers.sber.ru/docs/ru/policies/gigachat-agreement/corporate-clients-beta (ЮЛ).

Если вы не можете найти ответы на вопросы внутри этих документов, то перенаправляйте обращение к Доленко Дмитрий Дмитриевич <Dolenko.D.D@sberbank.ru>



### «Отменить покупку пакета с токенами/вернуть деньги»

Если пользователь (физлицо) хочет вернуть деньги или отменить покупку - надо подсветить https://developers.sber.ru/docs/ru/policies/gigachat-agreement/individuals пункт 4 11